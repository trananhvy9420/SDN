<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title><%= title %></title>
    <link href="/css/output.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  </head>
  <body class="bg-gray-200">
    <%- include('partials/header', { isLoggedIn: true }) %>

    <div class="container mx-auto p-4 md:p-8">
      <h1 class="text-4xl font-bold text-center text-gray-800 mb-8">
        Danh Sách Cầu Thủ
      </h1>

      <div class="mb-8 max-w-lg mx-auto">
        <div class="relative">
          <input
            type="text"
            id="search-input"
            placeholder="Tìm kiếm cầu thủ theo tên..."
            class="w-full px-4 py-3 border rounded-full shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 pr-10"
            autocomplete="off"
          />
          <button
            id="clear-search-btn"
            class="absolute inset-y-0 right-0 px-4 flex items-center text-gray-500 hover:text-gray-800 text-2xl font-bold hidden"
          >
            &times;
          </button>
        </div>
      </div>

      <div
        id="player-grid"
        class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"
      >
        <p class="col-span-full text-center text-gray-500">
          Đang tải danh sách cầu thủ...
        </p>
      </div>

      <div
        id="pagination-container"
        class="flex justify-center items-center mt-8 space-x-2"
      ></div>
    </div>

    <div
      id="detail-modal"
      class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden p-4"
    >
      <div
        class="bg-white p-6 rounded-lg shadow-xl w-full max-w-lg max-h-full overflow-y-auto"
      >
        <div class="flex justify-between items-center border-b pb-3 mb-4">
          <h2 id="modal-detail-name" class="text-2xl font-bold text-gray-800">
            Tên cầu thủ
          </h2>
          <button
            id="close-detail-modal"
            class="text-gray-500 hover:text-gray-800 text-3xl"
          >
            &times;
          </button>
        </div>
        <div>
          <img
            id="modal-detail-image"
            class="w-full h-64 object-cover rounded-md mb-4"
            src=""
            alt="Ảnh cầu thủ"
          />
          <p class="text-lg">
            <span class="font-bold">Giá:</span>
            <span id="modal-detail-cost"></span> $
          </p>
          <p
            id="modal-detail-isCaptain"
            class="text-lg font-bold text-yellow-600 my-2"
          ></p>
          <p class="text-base mt-4">
            <span class="font-bold">Thông tin chi tiết:</span>
          </p>
          <p
            id="modal-detail-info"
            class="text-gray-700 whitespace-pre-wrap"
          ></p>
        </div>
      </div>
    </div>

    <div
      id="comment-modal"
      class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden p-4"
    >
      <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md">
        <h2 class="text-2xl font-bold mb-4">
          Thêm bình luận cho
          <span id="modal-player-name" class="text-blue-600"></span>
        </h2>
        <form id="comment-form">
          <input type="hidden" id="modal-player-id" name="playerId" />
          <div class="mb-4">
            <label for="rating" class="block text-gray-700 mb-2"
              >Đánh giá (1-3 sao):</label
            >
            <select
              id="rating"
              name="rating"
              class="w-full p-2 border rounded"
              required
            >
              <option value="1">⭐</option>
              <option value="2">⭐⭐</option>
              <option value="3">⭐⭐⭐</option>
            </select>
          </div>
          <div class="mb-4">
            <label for="content" class="block text-gray-700 mb-2"
              >Nội dung:</label
            >
            <textarea
              id="content"
              name="content"
              rows="4"
              class="w-full p-2 border rounded"
              required
            ></textarea>
          </div>
          <div
            id="modal-error-message"
            class="text-red-500 text-sm mb-4 text-center"
          ></div>
          <div class="flex justify-end gap-4">
            <button
              type="button"
              id="close-comment-modal"
              class="bg-gray-300 text-gray-800 py-2 px-4 rounded hover:bg-gray-400"
            >
              Hủy
            </button>
            <button
              type="submit"
              class="bg-green-500 text-white py-2 px-4 rounded hover:bg-green-600"
            >
              Gửi bình luận
            </button>
          </div>
        </form>
      </div>
    </div>

    <div
      id="view-comments-modal"
      class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden p-4"
    >
      <div
        class="bg-white p-6 rounded-lg shadow-xl w-full max-w-2xl max-h-[80vh] flex flex-col"
      >
        <div
          class="flex justify-between items-center border-b pb-3 mb-4 flex-shrink-0"
        >
          <h2 class="text-2xl font-bold text-gray-800">Bình luận về cầu thủ</h2>
          <button
            id="close-view-comments-modal"
            class="text-gray-500 hover:text-gray-800 text-3xl"
          >
            &times;
          </button>
        </div>
        <div class="overflow-y-auto">
          <ul id="comments-list" class="space-y-4"></ul>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // --- DOM Elements ---
        const playerGrid = document.getElementById("player-grid");
        const paginationContainer = document.getElementById(
          "pagination-container"
        );
        const searchInput = document.getElementById("search-input");
        const clearSearchBtn = document.getElementById("clear-search-btn");
        const access_token = localStorage.getItem("access_token");

        // --- State ---
        let currentPage = 1;
        const limit = 8; // Số lượng cầu thủ mỗi trang

        // --- Render Functions ---

        // Hàm render danh sách cầu thủ
        const renderPlayers = (players) => {
          playerGrid.innerHTML = ""; // Xóa nội dung cũ (loading hoặc trang cũ)
          if (!players || players.length === 0) {
            playerGrid.innerHTML = `<p class="col-span-full text-center text-gray-500">Không tìm thấy cầu thủ nào.</p>`;
            return;
          }
          players.forEach((player) => {
            const playerCard = `
              <div class="bg-white rounded-lg shadow-lg overflow-hidden transition-transform transform hover:-translate-y-1">
                <div class="relative">
                  <img class="w-full h-56 object-cover view-comments-trigger cursor-pointer" src="${
                    player.image
                  }" alt="${player.playerName}" data-player-id="${player._id}">
                  ${
                    player.isCaptain
                      ? `<div class="absolute top-2 right-2 bg-yellow-400 text-yellow-900 text-xs font-bold px-3 py-1 rounded-full uppercase shadow-md">Captain</div>`
                      : ""
                  }
                </div>
                <div class="p-4">
                  <h2 class="text-xl font-bold text-gray-900 truncate">${
                    player.playerName
                  }</h2>
                  <p class="text-gray-600 mt-1">Giá: ${player.cost.toLocaleString()} $</p>
                  <p class="text-sm text-gray-500 mt-2 h-10 overflow-hidden">${
                    player.information || "Chưa có thông tin."
                  }</p>
                </div>
                <div class="p-4 border-t border-gray-200 flex justify-between gap-2">
                  <button class="flex-1 bg-gray-600 text-white py-2 px-4 rounded hover:bg-gray-700 transition-colors open-detail-modal" data-player-id="${
                    player._id
                  }">
                    Xem thêm
                  </button>
                  <button class="flex-1 bg-blue-500 text-white py-2 px-4 rounded hover:bg-blue-600 transition-colors open-comment-modal" data-player-id="${
                    player._id
                  }" data-player-name="${player.playerName}">
                    Bình luận
                  </button>
                </div>
              </div>`;
            playerGrid.insertAdjacentHTML("beforeend", playerCard);
          });
        };

        // Hàm render các nút phân trang
        const renderPagination = (pagination) => {
          paginationContainer.innerHTML = "";
          if (!pagination || pagination.totalPages <= 1) {
            return; // Không hiển thị nếu chỉ có 1 trang
          }

          const { currentPage, totalPages } = pagination;
          let paginationHTML = "";

          // Nút "Previous"
          paginationHTML += `
                <button class="px-4 py-2 mx-1 rounded ${
                  currentPage === 1
                    ? "bg-gray-300 cursor-not-allowed"
                    : "bg-white hover:bg-blue-500 hover:text-white"
                }" 
                        data-page="${currentPage - 1}" ${
            currentPage === 1 ? "disabled" : ""
          }>
                    &laquo;
                </button>`;

          // Các nút số trang
          for (let i = 1; i <= totalPages; i++) {
            paginationHTML += `
                    <button class="px-4 py-2 mx-1 rounded ${
                      i === currentPage
                        ? "bg-blue-500 text-white"
                        : "bg-white hover:bg-blue-500 hover:text-white"
                    }" 
                            data-page="${i}">
                        ${i}
                    </button>`;
          }

          // Nút "Next"
          paginationHTML += `
                <button class="px-4 py-2 mx-1 rounded ${
                  currentPage === totalPages
                    ? "bg-gray-300 cursor-not-allowed"
                    : "bg-white hover:bg-blue-500 hover:text-white"
                }" 
                        data-page="${currentPage + 1}" ${
            currentPage === totalPages ? "disabled" : ""
          }>
                    &raquo;
                </button>`;

          paginationContainer.innerHTML = paginationHTML;
        };

        // --- Core Fetching Function ---
        const fetchAndRenderPlayers = async (page) => {
          try {
            playerGrid.innerHTML = `<p class="col-span-full text-center text-gray-500">Đang tải...</p>`;
            const response = await axios.get(
              `/api/player/getAll?page=${page}&limit=${limit}`
            );
            renderPlayers(response.data.data);
            renderPagination(response.data.pagination);
            currentPage = page; // Cập nhật trang hiện tại
          } catch (error) {
            console.error("Lỗi khi tải danh sách cầu thủ:", error);
            playerGrid.innerHTML = `<p class="col-span-full text-center text-red-500">Không thể tải được dữ liệu.</p>`;
          }
        };

        // --- Event Listeners ---

        // Phân trang
        paginationContainer.addEventListener("click", (e) => {
          const button = e.target.closest("button");
          if (button && button.dataset.page) {
            const pageToGo = parseInt(button.dataset.page, 10);
            if (pageToGo !== currentPage) {
              fetchAndRenderPlayers(pageToGo);
            }
          }
        });

        // Tìm kiếm
        let searchTimeout;
        searchInput.addEventListener("input", (e) => {
          const query = e.target.value.trim();
          clearSearchBtn.classList.toggle("hidden", !query);

          // Debounce: Chờ người dùng gõ xong mới gửi request
          clearTimeout(searchTimeout);
          searchTimeout = setTimeout(async () => {
            if (!query) {
              paginationContainer.classList.remove("hidden");
              fetchAndRenderPlayers(1); // Quay về trang 1 khi xóa tìm kiếm
              return;
            }

            try {
              paginationContainer.classList.add("hidden"); // Ẩn phân trang khi tìm kiếm
              playerGrid.innerHTML = `<p class="col-span-full text-center text-gray-500">Đang tìm...</p>`;
              const response = await axios.get(
                `/api/player/search?playerName=${query}`
              );
              renderPlayers(response.data.data);
            } catch (error) {
              console.error("Lỗi khi tìm kiếm:", error);
              playerGrid.innerHTML = `<p class="col-span-full text-center text-red-500">Có lỗi xảy ra khi tìm kiếm.</p>`;
            }
          }, 300); // Chờ 300ms
        });

        clearSearchBtn.addEventListener("click", () => {
          searchInput.value = "";
          clearSearchBtn.classList.add("hidden");
          paginationContainer.classList.remove("hidden");
          fetchAndRenderPlayers(1); // Tải lại trang đầu
        });

        // Mở Modals (Sử dụng Event Delegation)
        playerGrid.addEventListener("click", async (e) => {
          const target = e.target;
          const openDetailButton = target.closest(".open-detail-modal");
          const openCommentButton = target.closest(".open-comment-modal");
          const viewCommentsTrigger = target.closest(".view-comments-trigger");

          // Mở modal xem chi tiết
          if (openDetailButton) {
            const playerId = openDetailButton.dataset.playerId;
            try {
              // ** MỚI: Gọi API để lấy chi tiết 1 cầu thủ **
              const response = await axios.get(
                `/api/player/searchByID?id=${playerId}`
              );
              const player = response.data.data;

              if (player) {
                document.getElementById("modal-detail-name").textContent =
                  player.playerName;
                document.getElementById("modal-detail-image").src =
                  player.image;
                document.getElementById("modal-detail-cost").textContent =
                  player.cost.toLocaleString();
                document.getElementById("modal-detail-info").textContent =
                  player.information || "Không có thông tin chi tiết.";
                const captainEl = document.getElementById(
                  "modal-detail-isCaptain"
                );
                if (player.isCaptain) {
                  captainEl.textContent = "⭐ Đội trưởng";
                  captainEl.classList.remove("hidden");
                } else {
                  captainEl.classList.add("hidden");
                }
                document
                  .getElementById("detail-modal")
                  .classList.remove("hidden");
              }
            } catch (error) {
              console.error("Lỗi khi lấy chi tiết cầu thủ:", error);
              alert("Không thể tải thông tin chi tiết cầu thủ.");
            }
          }

          // Mở modal bình luận (giữ nguyên)
          if (openCommentButton) {
            document.getElementById("modal-player-name").textContent =
              openCommentButton.dataset.playerName;
            document.getElementById("modal-player-id").value =
              openCommentButton.dataset.playerId;
            document.getElementById("comment-modal").classList.remove("hidden");
          }

          // Mở modal xem các bình luận (giữ nguyên)
          if (viewCommentsTrigger) {
            const playerId = viewCommentsTrigger.dataset.playerId;
            const commentsList = document.getElementById("comments-list");
            commentsList.innerHTML =
              '<p class="text-center text-gray-500">Đang tải bình luận...</p>';
            document
              .getElementById("view-comments-modal")
              .classList.remove("hidden");

            try {
              const response = await axios.get(
                `/api/player/${playerId}/comment`,
                {
                  headers: { Authorization: `Bearer ${access_token}` },
                }
              );
              const comments = response.data.data;
              commentsList.innerHTML = "";
              if (comments && comments.length > 0) {
                comments.forEach((comment) => {
                  const stars =
                    "⭐".repeat(comment.rating) +
                    "☆".repeat(3 - comment.rating);
                  const authorName = comment.author
                    ? comment.author.name
                    : "Người dùng ẩn danh";
                  commentsList.innerHTML += `
                                <li class="p-4 bg-gray-50 rounded-lg border">
                                    <div class="flex items-center justify-between mb-2">
                                        <p class="font-bold text-gray-800">${authorName}</p>
                                        <div class="text-lg">${stars}</div>
                                    </div>
                                    <p class="text-gray-700">${comment.content}</p>
                                </li>`;
                });
              } else {
                commentsList.innerHTML =
                  '<p class="text-center text-gray-500">Chưa có bình luận nào.</p>';
              }
            } catch (error) {
              commentsList.innerHTML =
                '<p class="text-center text-red-500">Không thể tải bình luận. Bạn cần đăng nhập để xem.</p>';
            }
          }
        });

        // Logic đóng modal và gửi form (giữ nguyên như cũ)
        const setupModalCloseLogic = (modalId, closeButtonId) => {
          const modal = document.getElementById(modalId);
          const closeButton = document.getElementById(closeButtonId);
          const closeModal = () => modal.classList.add("hidden");
          closeButton.addEventListener("click", closeModal);
          modal.addEventListener("click", (e) => {
            if (e.target === modal) closeModal();
          });
        };
        setupModalCloseLogic("detail-modal", "close-detail-modal");
        setupModalCloseLogic("comment-modal", "close-comment-modal");
        setupModalCloseLogic(
          "view-comments-modal",
          "close-view-comments-modal"
        );

        document
          .getElementById("comment-form")
          .addEventListener("submit", async (event) => {
            event.preventDefault();
            const modalErrorMessage = document.getElementById(
              "modal-error-message"
            );
            modalErrorMessage.textContent = "";

            const playerId = document.getElementById("modal-player-id").value;
            const rating = document.getElementById("rating").value;
            const content = document.getElementById("content").value;

            if (!access_token) {
              modalErrorMessage.textContent = "Bạn cần đăng nhập để bình luận!";
              return;
            }

            try {
              await axios.post(
                `/api/player/${playerId}/add-comment`,
                { rating, content },
                {
                  headers: { Authorization: `Bearer ${access_token}` },
                }
              );
              alert("Bình luận của bạn đã được thêm thành công!");
              document.getElementById("comment-modal").classList.add("hidden");
            } catch (error) {
              modalErrorMessage.textContent =
                error.response?.data?.message || "Đã có lỗi xảy ra.";
            }
          });

        // --- Initial Load ---
        fetchAndRenderPlayers(currentPage);
      });
    </script>
  </body>
</html>
